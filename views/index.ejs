<!DOCTYPE html>
<html>
  <head>
    <title><%= title %></title>
    <link rel='stylesheet' href='/stylesheets/style.css' />
	<script src="/javascripts/jquery-2.1.1.min.js"></script>
    <script src="/javascripts/template.js"></script>
  </head>
  <body>
    
	<div class="wrapper">
		<div class="page-item-btn">
			<button id="add-item-btn">添加</button>
            <button id="empty-item-btn">全部清空</button>
		</div>
        <div class="hide page-load">
            正在操作中，请稍后...
        </div>
		<div class="page-item-box" id="page-item-box">
            <% var list = detail.list; %>
            <% if (list && list.length) { %>

                <% for (var i = 0; i < list.length; i ++) { %>
                    <div class="page-item post-page-list">
                        <input class="tinput url" type="text" value="<%= list[i].sourcePage %>" placeholder="请输入微信页面地址" />
                        <div class="remote-post">
                            <form>
                                <input name="title" class="tinput title" type="text" value="<%= list[i].title %>"/>
                                <input name="pageUrl" type="hidden" value="<%= list[i].pageUrl || '' %>"/>
                                <input name="imgSrc" type="hidden" value="<%= list[i].imgSrc || '' %>"/>
                                <select name="in-category" class="select">
                                    <option selected="selected" value="2">叽歪笑话</option>
                                    <option value="11">爆笑体育</option>
                                    <option value="12">天下趣闻</option>
                                    <option value="13">幽默笑话</option>
                                    <option value="14">经典笑话</option>
                                    <option value="15">内涵笑话</option>
                                </select>
                                <label class="post-label"></label>

                                <select name="post-state" class="select post-state">
                                    <% if(list[i].pageUrl) { %>
                                        <option selected="selected" value="1">发布</option>
                                        <option value="2">不发布</option>
                                    <% }else{ %>
                                        <option value="1">发布</option>
                                        <option selected="selected" value="2">不发布</option>
                                    <% } %>
                                </select>
                                <span class="post-state">末发布</span>
                                <span class="hide post-msg">正在发布中，请稍后</span>
                            </form>
                        </div>
                    </div>
                <% } %>

            <% } else { %>
                <% for (var i = 0; i < 6; i ++) { %>
                <div class="page-item">
                    <input class="tinput url" type="text" value="" placeholder="请输入微信页面地址" />
                </div>
                <% } %>
            <% } %>
		</div>
		<div class="post-page">
			<input type="button" id="post-page-btn" value="抓取数据"  />
            <input type="button" id="update-title-btn" data-dir="<%= detail.dir %>" value="标题更新"  />
            <input type="button" id="remote-post-btn" value="远程同步"  />
		</div>
	</div>

    <script id="page-item-template" type="text/html">
        {{ var list = detail.list; }}
        {{ if (list.length) { }}
            {{ for (var i = 0; i < list.length; i ++) { }}
                <div class="page-item post-page-list">
                        <input class="tinput url" type="text" value="{{= list[i].sourcePage }}" placeholder="请输入微信页面地址" />
                        <div class="remote-post">
                            <form>
                                <input name="title" class="tinput title" type="text" value="{{= list[i].title }}" />
                                <input name="pageUrl" type="hidden" value="{{= list[i].pageUrl || '' }}" />
                                <input name="imgSrc" type="hidden" value="{{= list[i].imgSrc || '' }}" />
                                <select name="post_category" class="select">
                                    <option selected="selected" value="2">叽歪笑话</option>
                                    <option value="11">爆笑体育</option>
                                    <option value="12">天下趣闻</option>
                                    <option value="13">幽默笑话</option>
                                    <option value="14">经典笑话</option>
                                    <option value="15">内涵笑话</option>
                                </select>
                                <label class="post-label"></label>
                                <select name="post-state" class="select post-state">
                                    {{ if(list[i].pageUrl) { }}
                                        <option selected="selected" value="1">发布</option>
                                        <option value="2">不发布</option>
                                    {{ }else{ }}
                                        <option value="1">发布</option>
                                        <option selected="selected" value="2">不发布</option>
                                    {{ } }}
                                </select>
                                <span class="post-state">末发布</span>
                                <span class="post-msg">正在发布中，请稍后</span>
                            </form>
                        </div>
                </div>
            {{ } }}
        {{ } }}
    </script>
	
	<script>
		jQuery(function($){
			var addItemBtn = $('#add-item-btn'), emptyItemBtn = $('#empty-item-btn'),
			pageBox = $('#page-item-box'), 
			pageItemTemp = '<div class="page-item"><input type="text" placeholder="请输入微信页面地址" value=""></div>'; 
			addItemBtn.click(function(){
				pageBox.append(pageItemTemp);
			});

            emptyItemBtn.click(function(){
                pageBox.find('input').val('');
                pageBox.find('span').html('');
            });
			
			$('#post-page-btn').on('click', function(){
				var input = pageBox.find('input.url'), data = [], pageLoad = $('.page-load');

                pageLoad.show(0);
                input.each(function(){
					if(this.value ){
						data.push( this.value );
					}
				});
				
				$.ajax({
					url : '/fetch',
					dataType : 'json',
					type : 'post',
					data : {
						urls : JSON.stringify(data)
					},
					success : function( res ){
                        pageLoad.hide(0);
						if( res.success ) {
                            var detail = res.data;
                            $('#update-title-btn').attr('data-dir', detail.dir);
                            var html = template.render('page-item-template', {
                                detail : detail
                            });

                            $('#page-item-box').html( html );
                        }
					}
				})
			});


            $('#update-title-btn').on('click', function(){
                var input = pageBox.find('input.title'), dir =  $(this).attr('data-dir'), titles = [],
                    pageLoad = $('.page-load');

                pageLoad.show(0);
                input.each(function(){
                    if(this.value ){
                        titles.push( this.value );
                    }
                });



                $.ajax({
                    url : '/update',
                    dataType : 'json',
                    type : 'post',
                    data : {
                        titles : JSON.stringify(titles),
                        dir : dir
                    },
                    success : function( res ){
                        pageLoad.hide(0);
                        if( res.success ) {
                            var detail = res.data;
                            $('#update-title-btn').attr('data-dir', detail.dir);
                            var html = template.render('page-item-template', {
                                detail : detail
                            });

                            $('#page-item-box').html( html );
                        }
                    }
                })
            });


            $('#remote-post-btn').on('click', function(){
                 var remotePost = pageBox.find('.remote-post'), index = 0, len = remotePost.length;

                (function(){
                    if( index < len ) {
                        var postForm = remotePost.eq(index).find('form'),
                            postParam = postForm.serialize();

                        $.ajax({
                            url : '/remote',
                            dataType : 'json',
                            type : 'post',
                            data : {
                                index : index,
                                data : postParam
                            },
                            success : function( res ){
                                if( res.success ) {
                                     console.log( res.data );
                                }
                            }
                        })
                    }
                }());
            });
			
		});
	</script>
  </body>
</html>